# Face Search

## Installation

Install the project in editable mode:

```bash
pip install -e .
```

## Searching Actors

Use ``utils.search_actor.search_actor`` to compute a face embedding and search
against the index. To retrieve only the embedding along with a search function
for later use:

```python
from utils.search_actor import search_actor

results = search_actor("path/to/image.jpg", return_emb=True)
embedding = results["embedding"]
matches_by_movie = results["search_func"](embedding)
for movie_id, matches in matches_by_movie.items():
    print(movie_id, matches[:3])
```

When ``return_emb`` is ``False`` (default), ``search_actor`` returns a
dictionary keyed by ``movie_id``. Each value is a list of candidate characters
for that movie including scene metadata and preview paths.

## Command-line search

Run the search CLI from the terminal:

```bash
python cli/search_cli.py --image path/to/image.jpg \
    --sim-threshold 0.5 \
    --margin-threshold 0.05 \
    --top-k 5 \
    --ratio-threshold 1.1
```

All optional flags default to values in `configs/config.yaml` when not provided.

## Viewing search results

Use the viewer CLI to visualize candidate frames returned from the recognition
service:

```bash
python cli/search_viewer.py --image path/to/image.jpg --top-k 5
```

If the query is recognized, frames are grouped by movie using paths from
`frames_root`. When the face is unknown, the script falls back to nearest
candidates and displays preview images generated by
`tasks/preview_clusters_task.py`.

## Cluster Previews

`tasks/preview_clusters_task.py` tạo các ảnh minh họa cho từng cụm và lưu vào
thư mục được cấu hình tại `storage.cluster_previews_root`. Mỗi
`cluster_<id>` chứa tối đa 3 khung hình đại diện cùng với file
`metadata.json` mô tả thứ tự xuất hiện, timestamp và bbox tương ứng để phục vụ
việc xác nhận thủ công.

## Scene clip exports

`tasks/character_task.py` có thể ghi các đoạn clip MP4 ngắn cho từng track khi
`storage.scene_clips_root` được cấu hình. Bộ xuất hiện ưu tiên FourCC H.264
thân thiện với trình duyệt (`avc1`/`H264`) và chỉ quay lại `mp4v` khi bộ mã hóa
không khả dụng. Đảm bảo bản dựng OpenCV đi kèm FFmpeg hoặc GStreamer với hỗ trợ
H.264 (ví dụ `libx264`) để quá trình ghi clip hoạt động ổn định.

## Gateway service

The project ships with a small Express gateway (`gateway/server.js`) that proxies
frontend requests to the FastAPI service and background ingestion worker.

Set the following environment variables before starting the gateway:

- `PYTHON_URL`: base URL of the Python API that serves recognition, movies and
  scene endpoints (for example `http://localhost:8000`).
- `UPLOAD_DIR`: optional path where the gateway stores temporary uploads before
  forwarding them (defaults to `uploads` inside the project directory).
- `INGESTION_URL`: optional full URL of the ingestion worker endpoint. When not
  provided, the gateway forwards upload jobs to `${PYTHON_URL}/ingest`.

Available gateway routes:

- `POST /api/recognize`: forwards image recognition requests.
- `GET /api/movies`: retrieves the list of movies from the Python service.
- `POST /api/scene`: requests an alternative scene for the current selection.
- `POST /api/upload`: accepts a movie file, stores it temporarily and triggers
  the ingestion pipeline, returning the job identifier or status from the
  worker.