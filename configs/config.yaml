# =========================
# Face Search – CONFIG YAML
# =========================
seed: 42

# -------------------------
# CÁC ĐƯỜNG DẪN LƯU TRỮ
# -------------------------
storage:
  video_root: "Data/video"
  frames_root: "Data/frames"
  face_crops_root: "Data/face_crops"
  metadata_json: "Data/metadata.json"
  embeddings_folder_per_movie: "Data/embeddings"
  warehouse_embeddings: "warehouse/parquet/embeddings.parquet"
  warehouse_clusters: "warehouse/parquet/clusters.parquet"
  clusters_merged_parquet: "warehouse/parquet/clusters_merged.parquet"
  centroids_parquet: "warehouse/parquet/centroids.parquet"
  cluster_previews_root: "warehouse/cluster_previews"
  characters_json: "warehouse/characters.json"

# -------------------------
# CẤU HÌNH NHẬN DIỆN (EMBEDDING)
# -------------------------
embedding:
  model: "buffalo_l"
  l2_normalize: true
  providers: ["CUDAExecutionProvider", "CPUExecutionProvider"]

pca:
  enable: false

# =====================================================================
# CÁC NÚT VẶN TINH CHỈNH QUAN TRỌNG NHẤT
# =====================================================================

# -------------------------
# BƯỚC 1: TẠO CỤM BAN ĐẦU (CLUSTERING)
# -------------------------
clustering:
  algo: "agglomerative"
  metric: "euclidean"
  linkage: "complete"
  distance_threshold:
    # MỤC ĐÍCH: Kiểm soát độ "chặt" của các cụm ban đầu. Đây là khoảng cách tối đa (Euclidean)
    # giữa hai khuôn mặt để chúng được coi là thuộc cùng một cụm.
    # - TĂNG: Các cụm ban đầu sẽ lớn hơn, gộp được nhiều ảnh hơn nhưng có nguy cơ gộp nhầm (ảnh kém "sạch"). Ví dụ: 1.4
    # - GIẢM: Các cụm ban đầu sẽ nhỏ hơn, rất "sạch" nhưng dễ bị "xé nhỏ" (một người bị chia thành nhiều cụm). Ví dụ: 0.9
    default: 1.0

# -------------------------
# BƯỚC 2: GỘP ĐA GIAI ĐOẠN (MULTI-STAGE MERGE)
# -------------------------
# Giai đoạn 1: Tạo Hạt nhân (Cores)
merge:
  # MỤC ĐÍCH: Ngưỡng gộp các cụm ban đầu để tạo "Hạt nhân". Đây là ngưỡng ĐỘ TƯƠNG ĐỒNG (similarity)
  # tối thiểu giữa hai cụm để gộp chúng lại. Giá trị từ 0 đến 1.
  # - TĂNG: Gộp chặt hơn, yêu cầu hai cụm phải rất giống nhau mới gộp. An toàn hơn nhưng có thể không gộp được các góc mặt khác nhau. Ví dụ: 0.75
  # - GIẢM: Gộp lỏng hơn, "dễ dãi" hơn, có thể gộp được các góc mặt khác nhau nhưng có nguy cơ gộp nhầm hai người. Ví dụ: 0.55
  within_movie_threshold: 0.5

# Giai đoạn 2: Hấp thụ Vệ tinh (Satellites)
post_merge:
  enable: true
  metric: "cosine"
  # MỤC ĐÍCH: Ngưỡng "hấp thụ" các cụm Vệ tinh. Đây là KHOẢNG CÁCH tối đa (Cosine)
  # từ một cụm vệ tinh đến một cụm hạt nhân để nó được hấp thụ.
  # - TĂNG: Hấp thụ lỏng hơn, "dễ dãi" hơn. Một cụm vệ tinh có thể ở khá xa mà vẫn được gộp vào. Giúp gộp các góc mặt rất khác nhau nhưng có nguy cơ gộp nhầm. Ví dụ: 0.8
  # - GIẢM: Hấp thụ chặt hơn. Vệ tinh phải rất gần hạt nhân mới được gộp. An toàn hơn nhưng có thể bỏ sót các góc mặt khác nhau. Ví dụ: 0.6
  distance_threshold: 0.65

# -------------------------
# BƯỚC 3: BỘ LỌC KẾT QUẢ
# -------------------------
# Lọc để chọn Hạt nhân
filter_clusters:
  # MỤC ĐÍCH: Yêu cầu tối thiểu về số lượng ảnh "CHẤT LƯỢNG CAO" mà một cụm phải có
  # để được chọn làm "Hạt nhân".
  # - TĂNG: Yêu cầu khắt khe hơn. Chỉ những nhân vật xuất hiện nhiều và rõ nét mới được chọn làm hạt nhân. Giúp loại bỏ diễn viên phụ. Ví dụ: 15
  # - GIẢM: Yêu cầu lỏng hơn. Cho phép cả những diễn viên phụ (xuất hiện ít hơn) có cơ hội được chọn làm hạt nhân. Ví dụ: 7
  min_size: 3

# -------------------------
# BƯỚC 0: BỘ LỌC ĐẦU VÀO (QUALITY FILTERS)
# -------------------------
quality_filters:
  enable: true

  #phát hiện khuôn mặt
  min_det_score: 0.3

  #độ nét tối thiểu
  min_blur_clarity: 30.0

  # Cấu hình lọc đa tầng
  landmark_quality_filter:
    enable: true
    # đếm các bộ phận của khuôn mặt
    min_score_hard_cutoff: 0.4

#   thông số này kết hợp với min_size để tạo ra được cụm bao nhiêu hình
#   và mỗi hình bao nhiêu điểm trở lên sẽ được coi là cụm sạch cuối cùng.
    min_score_for_core: 0.85

# =====================================================================
# CÁC CẤU HÌNH KHÁC (Ít khi cần chỉnh)
# =====================================================================
preview:
  source: "frames"
  max_images_per_cluster: 999

filter:
  min_track_size: 5
  min_cluster_size: 3
tracklet:
  max_age: 3
  iou_threshold: 0.28

profiles:
  balanced: {}

