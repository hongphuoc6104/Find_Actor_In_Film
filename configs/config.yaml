# =========================
# Face Search – CONFIG YAML (đồng bộ BE hiện tại)
# =========================

seed: 42

storage:
  # Gốc dữ liệu
  video_root: "Data/video"              # khóa đang dùng
  videos_root: "Data/video"             # alias
  frames_root: "Data/frames"
  face_crops_root: "Data/face_crops"

  # Metadata & kho
  metadata_json: "Data/metadata.json"
  embeddings_folder_per_movie: "Data/embeddings"

  # Parquet thống nhất
  warehouse_embeddings: "warehouse/parquet/embeddings.parquet"
  warehouse_embeddings_pca: "warehouse/parquet/embeddings_pca.parquet"   # để trống/không dùng nếu PCA tắt
  warehouse_clusters: "warehouse/parquet/clusters.parquet"
  clusters_merged_parquet: "warehouse/parquet/clusters_merged.parquet"
  warehouse_noise: "warehouse/parquet/noise.parquet"

  # Centroid 512D cho nhận diện
  centroids_parquet: "warehouse/parquet/centroids.parquet"

  # Previews & output phụ trợ
  cluster_previews_root: "warehouse/cluster_previews"
  scene_clips_root: "warehouse/scene_clips"
  cluster_tuning_report: "reports/cluster_tuning.csv"

  # Manifest nhân vật
  characters_json: "warehouse/characters.json"

embedding:
  model: "buffalo_l"
  l2_normalize: true
  providers: ["CUDAExecutionProvider", "CPUExecutionProvider"]
  embedding_dim: 512

# PCA giữ để tương thích, nhưng mặc định TẮT
pca:
  enable: false
  n_components: 256
  whiten: false

# -------------------------
# Clustering (giữ cấu trúc hiện tại)
# -------------------------
clustering:
  algo: "agglomerative"
  metric: "euclidean"
  linkage: "complete"
  auto_distance_percentile: 95
  distance_threshold:
    default: 0.43
  distance_threshold_pca: 0.90
  hdbscan:
    use_precomputed: true
    min_cluster_size: 5
    min_samples: 5
  auto_optimize:
    enable: false
    distance_thresholds: [0.35, 0.4, 0.45, 0.5]
    metrics: ["euclidean", "cosine"]
    linkages: ["complete", "average"]
    min_track_count: 8
    min_clusters: 2
    max_clusters: 120
    cluster_weight: 0.0

# Alias cho code tham chiếu cluster.*
cluster:
  distance_threshold_pca: 0.90

merge:
  global_threshold: 0.78
  within_movie_threshold: 0.72

post_merge:
  enable: true
  metric: "euclidean"
  linkage: "average"
  distance_threshold: 0.55

filter:
  min_track_size: 5
  min_cluster_size: 3

filter_clusters:
  min_size: 6

quality_filters:
  enable: true
  min_det_score: 0.4
  min_face_ratio: 0.003
  min_blur_clarity: 60.0
  brightness:
    enable: true
    value_range: [30, 230]
  contrast:
    enable: true
    min_value: 25.0

centroid:
  method: "trimmed_mean"
  trim_ratio: 0.20

# -------------------------
# Preview (ảnh cụm)
# -------------------------
preview:
  source: "frames"                      # nếu muốn lấy crops → "crops"
  max_images_per_cluster: 24
  min_face_size: 0

# (Không dùng index/FAISS cũ nữa – đã loại bỏ index_path/index_map)

logging:
  mlflow_experiment: "face_discovery_mvp"

search:
  present_threshold: 0.5
  near_match_threshold: 0.3
  min_score: 0.25        # hạ một chút để dễ thấy kết quả
  max_results: 120
  threshold: 0.45
  top_k: 50
  max_scenes: 8

highlight:
  MIN_HL_DURATION_SEC: 4.0
  MERGE_GAP_SEC: 6.0
  TOP_K_HL_PER_SCENE: 3
  MIN_SCORE: 0.75
  SIM_THRESHOLD: 0.65

recognition:
  SIM_THRESHOLD: 0.25     # đồng bộ với search.min_score

frontend:
  SEEK_PAD_SEC: 0.0
  PAUSE_TOLERANCE_SEC: 0.2
  MIN_VIEWABLE_SEC: 0.35

tracklet:
  max_age: 3
  iou_threshold: 0.28

# -------------------------
# PROFILES
# -------------------------
profiles:
  co_trang_dong_duc:
    merge:   { within_movie_threshold: 0.84 }
    cluster: { distance_threshold_pca: 0.91 }
    filter_clusters: { min_size: 9 }
    tracklet: { max_age: 4, iou_threshold: 0.24 }

  hien_dai_tinh_cam:
    merge:   { within_movie_threshold: 0.80 }
    cluster: { distance_threshold_pca: 0.90 }
    filter_clusters: { min_size: 7 }
    tracklet: { max_age: 3, iou_threshold: 0.28 }

  hanh_dong_rung_lac:
    merge:   { within_movie_threshold: 0.86 }
    cluster: { distance_threshold_pca: 0.93 }
    filter_clusters: { min_size: 10 }
    tracklet: { max_age: 5, iou_threshold: 0.20 }

  xua_lang_que:
    merge:   { within_movie_threshold: 0.82 }
    cluster: { distance_threshold_pca: 0.90 }
    filter_clusters: { min_size: 8 }
    tracklet: { max_age: 3, iou_threshold: 0.26 }

  kinh_di_toi:
    merge:   { within_movie_threshold: 0.85 }
    cluster: { distance_threshold_pca: 0.92 }
    filter_clusters: { min_size: 9 }
    tracklet: { max_age: 4, iou_threshold: 0.22 }

  balanced:
    merge:   { within_movie_threshold: 0.82 }
    cluster: { distance_threshold_pca: 0.90 }
    filter_clusters: { min_size: 8 }
    tracklet: { max_age: 3, iou_threshold: 0.26 }
